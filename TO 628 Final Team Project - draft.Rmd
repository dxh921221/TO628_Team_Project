
---
title: "TO 628 Final Team Project"
author: "Team 7: Xuhao Dai, Anubhav Gupta, Yongsoo Shin, Priti Singh, Brian Tsai"
date: "Due on April 20, 2020"
output:
  html_document:
    theme: spacelab
    highlight: tango
    toc: true
    number_sections: true
    toc_depth: 2
    toc_float:
      collapsed: false
      smooth_scroll: true
---

# Class Topics
So far, we have learned about the following topics. For this project, one or more of the following options will be pursued for modeling and detailed analysis.

  1. Linear Regression
  2. Logistic Regression
  3. KNN
  4. ANN
  5. SVM
  6. Decision Trees
  7. Random Forest

# Motivation
To be filled out.

# Read Me
This document presents the group project for which city bike data in NYC is used. The purpose of this document is to share analysis of the influence of weather to the bike usage.

Here, city bike data from 2019 will be used for the analysis. Specifically, 5% of the entire 2019 data was extracted, and the extracted data was categorized into average ride usage per day (365 days in total). Thereafter, the yearly usage data was randomly divided into train (80%, 292 days) and test (20%, 73 days) for the modeling, testing the accuracy of the models, and business analytics. 

Ultimately, the findings will be used to identify the relationship between weather and bike usage and predict the bike usage based on chosen parameters (e.g. precipitation amount). Thereafter, some insights will be presented for the bike business.

Note that there was an effort to retrieve station capacity information into the dataset. However, it was not pursued as only 20% of the stations in the dataset were identified with the capacity.

# Dataset Explanation
  - City bike data in NYC
  - Each dataset is comprised of 1 month trip data
    - Data from 12 months of 2019 have been combined and divided into train (80%) and test (20%) datasets.
  - Variables (City bike):
    - trip duration (sec)
    - start time (year, month, day, time)
    - stop time (year, month, day, time)
    - start station (id, lat/long)
    - end station (id, lat/long)
    - bike id
    - user type
      - customer (24 hr vs 3 day)
      - subscriber (annual)
    - birth year
    - gender (0, 1, 2 = unknown, male, female)
    - trip distance (based on the lat/long, trip distance was calculated with r package haversine)
    - trip speed (based on trip distance, trip speed was calculated with trip duration)
    - total # bike rentals (per day)
  - Variables (Weather):
    - TMIN (minimum temperature in C)
    - TMAX (maximum temperature in C)
    - Average wind speed
    - PRCP (mm)
    - SNOW (mm)

# Load Datasets
```{r}
#load train dataset
traindata = read.csv("train_final.csv")

#load test dataset
testdata = read.csv("test_final.csv")

#load data - station information
#station_info = read.csv("station_information.csv")

```

# Clean up Datasets
Ensure that no additional clean up is needed after train and test datasets are extracted from the entire 2019 usage.
```{r}

#train dataset
traindata$X = NULL
traindata$Date = NULL
traindata$start_station_id = as.integer(traindata$start_station_id)
colnames(traindata)
str(traindata)
summary(traindata)


#test dataset
testdata$X = NULL
testdata$Date = NULL
testdata$start_station_id = as.integer(testdata$start_station_id)
colnames(testdata)
str(testdata)
summary(testdata)

```

# Further Data Exploration
```{r}

#1. trip duration
boxplot(traindata$avg_trip_duration, main = "trip duration (sec)")
hist(traindata$avg_trip_duration, main = "trip duration (sec)")

#5. birth year
summary(traindata$age_group)

#6. user type
summary(traindata$usertype)

```

# Data Preparation for Modeling
Data has been reorganized to split the data per each day. Information about start day and end day are treated separately. The information of interest are: average birth year, average trip duration, and total check-ins/check-outs per given day.

```{r}
# Look for and download plyr package if it does not already exist
if (!require("plyr")) {
  install.packages("plyr")
}
#read in plyr package
library(plyr)

#organize data per day (avg trip duration, avg speed per day, total check out per day, avg travel distance per day)
train_per_day = ddply(traindata,.(start_month,start_day, avg_wind_speed, TMIN, TMAX, PRCP, SNOW), c(function(x) mean(x$avg_trip_duration), function(x) mean(x$avg_speed), function(x) sum(x$frequency)))
colnames(train_per_day) = c("start_month","start_day","avg_wind_speed","TMIN","TMAX","PRCP","SNOW","avg_trip_duration","avg_speed","frequency")

test_per_day = ddply(testdata,.(start_month,start_day, avg_wind_speed, TMIN, TMAX, PRCP, SNOW), c(function(x) mean(x$avg_trip_duration), function(x) mean(x$avg_speed), function(x) sum(x$frequency)))
colnames(test_per_day) = c("start_month","start_day","avg_wind_speed","TMIN","TMAX","PRCP","SNOW","avg_trip_duration","avg_speed","frequency")

head(train_per_day)
summary(train_per_day)
head(test_per_day)
summary(test_per_day)
```

# Modeling

  1. Topics learned in class
    1. Linear Regression
    2. Logistic Regression
    3. KNN
    4. ANN
    5. SVM
    6. Decision Trees
    7. Random Forest
  2. Modeling
    1. avg trip duration per day
    2. avg speed per day
    3. total check outs per day
    4. avg travel distance per day
    5. age group
    6. Others: customer type, time of travel

## Avg trip duration per day

### Linear model
```{r}
#model

trip_duration_linear <- lm(avg_trip_duration ~ start_month + start_day + avg_wind_speed + TMIN + TMAX + PRCP + SNOW, data = train_per_day)

summary(trip_duration_linear)

#predict
trip_duration_pred_linear <- predict(trip_duration_linear, test_per_day) 

#compare
plot(trip_duration_pred_linear, test_per_day$avg_trip_duration, main = "Linear model Prediction Assessmen",
     xlab = "predicted" , ylab = "actual")
abline(a = 0, b = 1, col = "red")


#compute prediction accuracy with threshold of 5%
trip_duration_accuracy_linear = ifelse(abs(trip_duration_pred_linear - test_per_day$avg_trip_duration)/test_per_day$avg_trip_duration > 0.10, 0, 1)

trip_duration_accuracy_linear

```

### KNN
```{r}

#load library
library(class)

#model
train_labels = train_per_day$avg_trip_duration
test_labels = test_per_day$avg_trip_duration

#predict
trip_duration_pred_knn = knn(train = train_per_day, test = test_per_day, cl = train_labels, k = 17) #sqrt(sample size) is a rule of thumb

#compare
plot((as.numeric(levels(trip_duration_pred_knn))[trip_duration_pred_knn]), test_per_day$avg_trip_duration, main = "KNN model Prediction Assessment", xlab="predicted", ylab="actual")
abline(a = 0, b = 1, col = "red")

#compute prediction accuracy with threshold of 5%
trip_duration_accuracy_knn = ifelse(abs((as.numeric(levels(trip_duration_pred_knn))[trip_duration_pred_knn]) - test_per_day$avg_trip_duration)/test_per_day$avg_trip_duration > 0.10, 0, 1)

```
### ANN
```{r}

#load library
library(neuralnet)

#model
trip_duration_model_ann = neuralnet(formula = avg_trip_duration ~ start_month + start_day + avg_wind_speed + TMIN + TMAX + PRCP + SNOW, data = train_per_day, hidden = 3)

#predict
trip_duration_pred_ann = compute(trip_duration_model_ann, test_per_day)
trip_duration_pred_ann_result = trip_duration_pred_ann$net.result

#compare
plot(trip_duration_pred_ann_result, test_per_day$avg_trip_duration, main = "ANN model Prediction Assessment", xlab="predicted", ylab="actual")
abline(a = 0, b = 1, col = "red")

#compute prediction accuracy with threshold of 5%
trip_duration_accuracy_ann = ifelse(abs(trip_duration_pred_ann_result - test_per_day$avg_trip_duration)/test_per_day$avg_trip_duration > 0.10, 0, 1)

```

### SVM
```{r}

#load library
library(kernlab)

#model
trip_duration_model_svm = ksvm(avg_trip_duration ~ start_month + start_day + avg_wind_speed + TMIN + TMAX + PRCP + SNOW, data = train_per_day, kernel = "vanilladot")
  
#predict
trip_duration_pred_svm = predict(trip_duration_model_svm, test_per_day)

#compare
plot(trip_duration_pred_svm, test_per_day$avg_trip_duration, main = "SVM model Prediction Assessment", xlab="predicted", ylab="actual")
abline(a = 0, b = 1, col = "red")

#compute prediction accuracy with threshold of 5%
trip_duration_accuracy_svm = ifelse(abs(trip_duration_pred_svm - test_per_day$avg_trip_duration)/test_per_day$avg_trip_duration > 0.10, 0, 1)
```

### Decision Trees
```{r}

#load library
library(C50)

#model
trip_duration_model_dt = C5.0(as.factor(avg_trip_duration) ~ start_month + start_day + avg_wind_speed + TMIN + TMAX + PRCP + SNOW, data = train_per_day)
  
#predict
trip_duration_pred_dt = predict(trip_duration_model_dt, test_per_day)

#compare
plot((as.numeric(levels(trip_duration_pred_dt))[trip_duration_pred_dt]), test_per_day$avg_trip_duration, main = "Decision Tree model Prediction Assessment", xlab="predicted", ylab="actual")
abline(a = 0, b = 1, col = "red")

#compute prediction accuracy with threshold of 5%
trip_duration_accuracy_dt = ifelse(abs((as.numeric(levels(trip_duration_pred_dt))[trip_duration_pred_dt]) - test_per_day$avg_trip_duration)/test_per_day$avg_trip_duration > 0.10, 0, 1)

```

### Random Forest
```{r}
#load library
library(randomForest)

#model
set.seed(12345)
trip_duration_model_rf = randomForest(as.factor(avg_trip_duration) ~ start_month + start_day + avg_wind_speed + TMIN + TMAX + PRCP + SNOW, data = train_per_day)
  
#predict
trip_duration_pred_rf = predict(trip_duration_model_rf, test_per_day)

#compare
plot((as.numeric(levels(trip_duration_pred_rf))[trip_duration_pred_rf]), test_per_day$avg_trip_duration, main = "Random Forest model Prediction Assessment", xlab="predicted", ylab="actual")
abline(a = 0, b = 1, col = "red")

#compute prediction accuracy with threshold of 5%
trip_duration_accuracy_rf = ifelse(abs((as.numeric(levels(trip_duration_pred_rf))[trip_duration_pred_rf]) - test_per_day$avg_trip_duration)/test_per_day$avg_trip_duration > 0.10, 0, 1)

```
### Assess Models
```{r}
trip_duration_model_comparison = matrix(0, nrow=6, ncol=3)
colnames(trip_duration_model_comparison) = c("bad_prediction","good_prediction", "accuracy")
rownames(trip_duration_model_comparison) = c("linear","knn","ann","svm","decision_tree","random_forst")

trip_duration_model_comparison[1,] = c((length(trip_duration_accuracy_linear)-sum(trip_duration_accuracy_linear)), sum(trip_duration_accuracy_linear), round(sum(trip_duration_accuracy_linear)/length(trip_duration_accuracy_linear),3))
trip_duration_model_comparison[2,] = c((length(trip_duration_accuracy_knn)-sum(trip_duration_accuracy_knn)), sum(trip_duration_accuracy_knn), round(sum(trip_duration_accuracy_knn)/length(trip_duration_accuracy_knn),3))
trip_duration_model_comparison[3,] = c((length(trip_duration_accuracy_ann)-sum(trip_duration_accuracy_ann)), sum(trip_duration_accuracy_ann), round(sum(trip_duration_accuracy_ann)/length(trip_duration_accuracy_ann),3))
trip_duration_model_comparison[4,] = c((length(trip_duration_accuracy_svm)-sum(trip_duration_accuracy_svm)), sum(trip_duration_accuracy_svm), round(sum(trip_duration_accuracy_svm)/length(trip_duration_accuracy_svm),3))
trip_duration_model_comparison[5,] = c((length(trip_duration_accuracy_dt)-sum(trip_duration_accuracy_dt)), sum(trip_duration_accuracy_dt), round(sum(trip_duration_accuracy_dt)/length(trip_duration_accuracy_dt),3))
trip_duration_model_comparison[6,] = c((length(trip_duration_accuracy_rf)-sum(trip_duration_accuracy_rf)), sum(trip_duration_accuracy_rf), round(sum(trip_duration_accuracy_rf)/length(trip_duration_accuracy_rf),3))

```

### Findings

Based on the different models assessed, SVM gave the best prediction of average trip duration with the accuracy of ~79.5%. This is considering that the results are accurate if lying within 10% range of the actual trip duration value.

From the linear model, it can be concluded that there is a relationship between average trip duration and different weather parameters. For example, it was found that TMAX had a positive relationship and PRCP had a negative relationship with average trip duration. From this, it can be concluded that warmer days have longer rides and rainy days have shorter rides in general.

Additionally, it was found that start month is negatively related to the average bike speed. This finding can be correlated with the weather-related finding noted above in a way that higher month (colder weather) results in faster bike speed.

There was no significant impact of variables TMIN, SNOW, start_month, and start_day. This indicates that the trip duration is not impacted by lower temperatures, snow amount, and trip month or day. 

```{r}

trip_duration_model_comparison

```


## Avg speed per day
### Linear Model
```{r}

#model
speed_model_linear = lm(avg_speed ~ start_month + start_day + avg_wind_speed + TMIN + TMAX + PRCP + SNOW, data = train_per_day)

summary(speed_model_linear)

#predict
speed_pred_linear = predict(speed_model_linear, newdata = test_per_day)

#compare
plot(speed_pred_linear, test_per_day$avg_speed, main = "Linear model Prediction Assessment", xlab="predicted", ylab="actual")
abline(a = 0, b = 1, col = "red")

#compute prediction accuracy with threshold of 5%
speed_accuracy_linear = ifelse(abs(speed_pred_linear - test_per_day$avg_speed)/test_per_day$avg_speed > 0.05, 0, 1)

```

### KNN
```{r}

#load library
library(class)

#model
train_labels = train_per_day$avg_speed
test_labels = test_per_day$avg_speed

#predict
speed_pred_knn = knn(train = train_per_day, test = test_per_day, cl = train_labels, k = 17) #sqrt(sample size) is a rule of thumb

#compare
plot((as.numeric(levels(speed_pred_knn))[speed_pred_knn]), test_per_day$avg_speed, main = "KNN model Prediction Assessment", xlab="predicted", ylab="actual")
abline(a = 0, b = 1, col = "red")

#compute prediction accuracy with threshold of 5%
speed_accuracy_knn = ifelse(abs((as.numeric(levels(speed_pred_knn))[speed_pred_knn]) - test_per_day$avg_speed)/test_per_day$avg_speed > 0.05, 0, 1)

```

### ANN
```{r}

#load library
library(neuralnet)

#model
speed_model_ann = neuralnet(formula = avg_speed ~ start_month + start_day + avg_wind_speed + TMIN + TMAX + PRCP + SNOW, data = train_per_day, hidden = 3)

#predict
speed_pred_ann = compute(speed_model_ann, test_per_day)
speed_pred_ann_result = speed_pred_ann$net.result

#compare
plot(speed_pred_ann_result, test_per_day$avg_speed, main = "ANN model Prediction Assessment", xlab="predicted", ylab="actual")
abline(a = 0, b = 1, col = "red")

#compute prediction accuracy with threshold of 5%
speed_accuracy_ann = ifelse(abs(speed_pred_ann_result - test_per_day$avg_speed)/test_per_day$avg_speed > 0.05, 0, 1)

```

### SVM
```{r}

#load library
library(kernlab)

#model
speed_model_svm = ksvm(avg_speed ~ start_month + start_day + avg_wind_speed + TMIN + TMAX + PRCP + SNOW, data = train_per_day, kernel = "vanilladot")
  
#predict
speed_pred_svm = predict(speed_model_svm, test_per_day)

#compare
plot(speed_pred_svm, test_per_day$avg_speed, main = "SVM model Prediction Assessment", xlab="predicted", ylab="actual")
abline(a = 0, b = 1, col = "red")

#compute prediction accuracy with threshold of 5%
speed_accuracy_svm = ifelse(abs(speed_pred_svm - test_per_day$avg_speed)/test_per_day$avg_speed > 0.05, 0, 1)
```

### Decision Trees
```{r}

#load library
library(C50)

#model
speed_model_dt = C5.0(as.factor(avg_speed) ~ start_month + start_day + avg_wind_speed + TMIN + TMAX + PRCP + SNOW, data = train_per_day)
  
#predict
speed_pred_dt = predict(speed_model_dt, test_per_day)

#compare
plot((as.numeric(levels(speed_pred_dt))[speed_pred_dt]), test_per_day$avg_speed, main = "Decision Tree model Prediction Assessment", xlab="predicted", ylab="actual")
abline(a = 0, b = 1, col = "red")

#compute prediction accuracy with threshold of 5%
speed_accuracy_dt = ifelse(abs((as.numeric(levels(speed_pred_dt))[speed_pred_dt]) - test_per_day$avg_speed)/test_per_day$avg_speed > 0.05, 0, 1)

```

### Random Forest
```{r}
#load library
library(randomForest)

#model
set.seed(12345)
speed_model_rf = randomForest(as.factor(avg_speed) ~ start_month + start_day + avg_wind_speed + TMIN + TMAX + PRCP + SNOW, data = train_per_day)
  
#predict
speed_pred_rf = predict(speed_model_rf, test_per_day)

#compare
plot((as.numeric(levels(speed_pred_rf))[speed_pred_rf]), test_per_day$avg_speed, main = "Random Forest model Prediction Assessment", xlab="predicted", ylab="actual")
abline(a = 0, b = 1, col = "red")

#compute prediction accuracy with threshold of 5%
speed_accuracy_rf = ifelse(abs((as.numeric(levels(speed_pred_rf))[speed_pred_rf]) - test_per_day$avg_speed)/test_per_day$avg_speed > 0.05, 0, 1)

```

### Assess Models
```{r}
speed_model_comparison = matrix(0, nrow=6, ncol=3)
colnames(speed_model_comparison) = c("bad_prediction","good_prediction", "accuracy")
rownames(speed_model_comparison) = c("linear","knn","ann","svm","decision_tree","random_forst")

speed_model_comparison[1,] = c((length(speed_accuracy_linear)-sum(speed_accuracy_linear)), sum(speed_accuracy_linear), round(sum(speed_accuracy_linear)/length(speed_accuracy_linear),3))
speed_model_comparison[2,] = c((length(speed_accuracy_knn)-sum(speed_accuracy_knn)), sum(speed_accuracy_knn), round(sum(speed_accuracy_knn)/length(speed_accuracy_knn),3))
speed_model_comparison[3,] = c((length(speed_accuracy_ann)-sum(speed_accuracy_ann)), sum(speed_accuracy_ann), round(sum(speed_accuracy_ann)/length(speed_accuracy_ann),3))
speed_model_comparison[4,] = c((length(speed_accuracy_svm)-sum(speed_accuracy_svm)), sum(speed_accuracy_svm), round(sum(speed_accuracy_svm)/length(speed_accuracy_svm),3))
speed_model_comparison[5,] = c((length(speed_accuracy_dt)-sum(speed_accuracy_dt)), sum(speed_accuracy_dt), round(sum(speed_accuracy_dt)/length(speed_accuracy_dt),3))
speed_model_comparison[6,] = c((length(speed_accuracy_rf)-sum(speed_accuracy_rf)), sum(speed_accuracy_rf), round(sum(speed_accuracy_rf)/length(speed_accuracy_rf),3))

```

### Findings
It turns out that svm is best at predicting the average speed with the accuracy of ~74%. 

From the linear model, it can be concluded that there is a relationship between average bike speed and weather parameters. For example, it was found that wind speed/TMAX had negative relationship and PRCP had positive relationship with average bike speed. From this, it can be concluded that worse weather results in faster bike speed.

Additionally, it was found that start month is negatively related to the average bike speed. This finding can be correlated with the weather-related finding noted above in a way that higher month (colder weather) results in faster bike speed.

```{r}
speed_model_comparison
```

## Total check outs per day
```{r}

```

## Avg travel distance per day
```{r}

```

## Age group
```{r}

```








